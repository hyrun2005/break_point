{% extends "players/base.html" %}
{% load static %}

{% block title %}Predict Match{% endblock %}

{% block content %}
    <style>
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes moveLight {
            0% {
                background-position: 0 0;
            }
            100% {
                background-position: 100% 100%;
            }
        }

        .animate-fadeIn {
            animation: fadeIn 0.6s ease-out;
        }

        .court-bg {
            background: radial-gradient(circle at 50% 0%, rgba(59, 130, 246, 0.08), transparent 70%);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            animation: moveLight 18s infinite linear;
            z-index: -1;
        }

        .glow-card {
            background: linear-gradient(145deg, rgba(17, 24, 39, 0.9), rgba(30, 41, 59, 0.85));
            border: 1px solid rgba(59, 130, 246, 0.25);
            transition: all 0.3s ease;
        }

        .glow-card:hover {
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-3px);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.25);
        }

        .player-name {
            max-width: 220px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ✅ Sticky Sidebar */
        .sticky-sidebar {
            position: sticky;
            top: 23px;
            margin-top: 108px;
            align-self: flex-start;
        }
    </style>

    <!-- ⚠️ Popup -->
    <div id="popup_warning"
         class="fixed top-6 left-1/2 -translate-x-1/2 z-50
            bg-red-500 text-white text-sm font-semibold
            px-6 py-3 rounded-xl shadow-md opacity-0
            transition-opacity duration-500 ease-out">
    </div>

    <script>
        function showPopupWarning(message) {
            const popup = document.getElementById("popup_warning");
            popup.textContent = "⚠️ " + message;
            popup.classList.remove("opacity-0");
            popup.classList.add("opacity-100");
            setTimeout(() => {
                popup.classList.remove("opacity-100");
                popup.classList.add("opacity-0");
            }, 3000);
        }
    </script>

    <div class="relative z-0 min-h-screen text-gray-100 py-10 px-8 font-[Montserrat] bg-gradient-to-b from-gray-950 to-gray-900">
        <div class="court-bg"></div>

        <!-- MAIN FLEX CONTAINER -->
        <div class="relative z-10 flex flex-col lg:flex-row gap-10 items-start">

            <!-- LEFT SIDE -->
            <div class="flex-[0.65] space-y-10">

                <!-- TITLE -->
                <div class="mb-6">
                    <h2 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-cyan-300 to-blue-500">
                        AI Tennis Match Predictor
                    </h2>
                    <p class="text-gray-400 mt-2 text-sm tracking-wide">
                        Compare ATP players and get instant AI-based predictions.
                    </p>
                </div>

                <!-- FORM -->
                <form method="POST" class="space-y-10">
                    {% csrf_token %}

                    <!-- PLAYER 1 -->
                    <div id="player1_section" class="glow-card rounded-2xl p-8">
                        <h4 class="text-blue-400 text-lg font-semibold mb-4">Player 1</h4>
                        <div class="flex flex-col md:flex-row items-center justify-between gap-6">
                            <img id="player1_img" src="{% static 'predictions/images/anonymo.png' %}"
                                 class="rounded-xl shadow-md max-w-[180px] object-cover">
                            <div class="flex flex-col flex-grow w-full items-center">
                                <select name="player1" id="player1_select"
                                        class="w-full max-w-sm bg-gray-800 border border-gray-700 rounded-xl px-3 py-2 text-gray-100 focus:ring-2 focus:ring-blue-400 hover:bg-gray-700 transition mb-5">
                                    <option value="">Choose...</option>
                                    {% for p in players %}
                                        <option value="{{ p.id }}"
                                                data-rank="{{ p.rank }}"
                                                data-photo="
                                                        {% if p.photo %}{{ p.photo }}{% else %}{% static 'predictions/images/anonymo.png' %}{% endif %}"
                                                data-aces="{{ p.stats.aces|default:'-' }}"
                                                data-matches="{{ p.career_record.wl_record|default:'-' }}"
                                                data-prize="{{ p.career_record.prize_money|default:'-' }}">
                                            {{ p.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-sm text-center">
                                    <div><span class="block text-xs text-blue-300">Rank</span><strong
                                            id="pl1_rank">-</strong></div>
                                    <div><span class="block text-xs text-blue-300">W-L</span><strong
                                            id="pl1_wl">-</strong></div>
                                    <div><span class="block text-xs text-blue-300">Aces</span><strong
                                            id="pl1_aces">-</strong></div>
                                    <div><span class="block text-xs text-blue-300">Prize</span><strong
                                            id="pl1_prize">-</strong></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PLAYER 2 -->
                    <div class="glow-card rounded-2xl p-8">
                        <h4 class="text-blue-400 text-lg font-semibold mb-4">Player 2</h4>
                        <div class="flex flex-col md:flex-row items-center justify-between gap-6">
                            <img id="player2_img" src="{% static 'predictions/images/anonymo.png' %}"
                                 class="rounded-xl shadow-md max-w-[180px] object-cover">
                            <div class="flex flex-col flex-grow w-full items-center">
                                <select name="player2" id="player2_select"
                                        class="w-full max-w-sm bg-gray-800 border border-gray-700 rounded-xl px-3 py-2 text-gray-100 focus:ring-2 focus:ring-blue-400 hover:bg-gray-700 transition mb-5">
                                    <option value="">Choose...</option>
                                    {% for p in players %}
                                        <option value="{{ p.id }}"
                                                data-rank="{{ p.rank }}"
                                                data-photo="
                                                        {% if p.photo %}{{ p.photo }}{% else %}{% static 'predictions/images/anonymo.png' %}{% endif %}"
                                                data-aces="{{ p.stats.aces|default:'-' }}"
                                                data-matches="{{ p.career_record.wl_record|default:'-' }}"
                                                data-prize="{{ p.career_record.prize_money|default:'-' }}">
                                            {{ p.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-sm text-center">
                                    <div><span class="block text-xs text-blue-300">Rank</span><strong
                                            id="pl2_rank">-</strong></div>
                                    <div><span class="block text-xs text-blue-300">W-L</span><strong
                                            id="pl2_wl">-</strong></div>
                                    <div><span class="block text-xs text-blue-300">Aces</span><strong
                                            id="pl2_aces">-</strong></div>
                                    <div><span class="block text-xs text-blue-300">Prize</span><strong
                                            id="pl2_prize">-</strong></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- MATCH SETTINGS -->
                    <div class="glow-card rounded-2xl p-8 space-y-6">
                        <h4 class="text-blue-400 text-lg font-semibold text-center">Match Settings</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
                            {% for label, field in match_fields %}
                                <div>
                                    <label class="text-blue-300 text-sm font-medium mb-1">{{ label }}</label>
                                    {% if "seed" in field %}
                                        <input type="number" name="{{ field }}" placeholder="0" min="0"
                                               class="bg-gray-800 border border-gray-700 rounded-xl px-3 py-2 text-gray-100 focus:ring-2 focus:ring-blue-400 hover:bg-gray-700 transition w-full">
                                    {% else %}
                                        <select name="{{ field }}"
                                                class="w-full bg-gray-800 border border-gray-700 rounded-xl px-3 py-2 text-gray-100 focus:ring-2 focus:ring-blue-400 hover:bg-gray-700 transition">
                                            {% if field == "tourney_level" %}
                                                {% for val, lbl in tourney_levels %}
                                                    <option value="{{ val }}">{{ lbl }}</option>{% endfor %}
                                            {% elif field == "surface" %}
                                                {% for val, lbl in surfaces %}
                                                    <option value="{{ val }}">{{ lbl }}</option>{% endfor %}
                                            {% elif field == "round_encoded" %}
                                                {% for val, lbl in rounds %}
                                                    <option value="{{ val }}">{{ lbl }}</option>{% endfor %}
                                            {% elif field == "best_of" %}
                                                {% for val, lbl in best_of %}
                                                    <option value="{{ val }}">{{ lbl }}</option>{% endfor %}
                                            {% elif field == "draw_size" %}
                                                <option value="32">32</option>
                                                <option value="64">64</option>
                                                <option value="128">128</option>
                                            {% endif %}
                                        </select>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="text-center mt-6">
                        <button type="submit"
                                class="bg-gradient-to-r from-blue-500 to-cyan-400 hover:from-blue-600 hover:to-cyan-500 text-white font-semibold py-3 px-14 rounded-full shadow-lg hover:shadow-cyan-600/40 transition duration-300 transform hover:scale-105">
                            ⚡ Predict Match
                        </button>
                    </div>
                </form>

                <div id="prediction_result"></div>
            </div>

            <!-- RIGHT SIDE (Sticky sidebar with 219px offset) -->
            <aside class="flex-[0.35] space-y-6 sticky-sidebar">
                <div class="glow-card rounded-2xl p-6 backdrop-blur-sm bg-gray-900/70 border border-blue-400/20">
                    <h4 class="text-blue-400 text-lg font-semibold mb-4">AI Model Insights</h4>
                    <p class="text-gray-400 text-sm leading-relaxed">
                        Our AI predictor uses player stats, ATP rankings, and historical data.
                        It learns from over <span class="text-blue-300">50,000+</span> matches to deliver consistent
                        accuracy across surfaces.
                    </p>
                </div>

                <div class="glow-card rounded-2xl p-6 backdrop-blur-sm bg-gray-900/70 border border-blue-400/20">
                    <h4 class="text-blue-400 text-lg font-semibold mb-3">Tips</h4>
                    <ul class="text-gray-400 text-sm space-y-2">
                        <li>🎯 Use current rankings for best accuracy.</li>
                        <li>🌍 Surface type affects match outcomes heavily.</li>
                        <li>🏆 “Best Of” value influences player endurance.</li>
                    </ul>
                </div>
            </aside>
        </div>
    </div>

    <script>
        function updatePlayer(selectId, imgId, prefix, otherSelectId) {
            const select = document.getElementById(selectId);
            const img = document.getElementById(imgId);
            const otherSelect = document.getElementById(otherSelectId);
            select.addEventListener("change", function () {
                const opt = this.options[this.selectedIndex];
                img.src = opt.dataset.photo || "{% static 'predictions/images/anonymo.png' %}";
                document.getElementById(`${prefix}_rank`).textContent = opt.dataset.rank || "-";
                document.getElementById(`${prefix}_wl`).textContent = opt.dataset.matches || "-";
                document.getElementById(`${prefix}_aces`).textContent = opt.dataset.aces || "-";
                document.getElementById(`${prefix}_prize`).textContent = opt.dataset.prize || "-";
                Array.from(otherSelect.options).forEach(o => o.disabled = o.value && o.value === opt.value);
            });
        }

        updatePlayer("player1_select", "player1_img", "pl1", "player2_select");
        updatePlayer("player2_select", "player2_img", "pl2", "player1_select");

        document.querySelector("form").addEventListener("submit", async e => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const response = await fetch("", {
                method: "POST",
                headers: {"X-Requested-With": "XMLHttpRequest"},
                body: formData
            });
            const resultBox = document.querySelector("#prediction_result");
            if (response.ok) {
                const data = await response.json();
                const p1Prob = parseFloat(data.p1_win);
                const p2Prob = parseFloat(data.p2_win);
                const winner = "text-green-400 drop-shadow-[0_0_8px_rgba(34,197,94,0.8)]";
                const loser = "text-blue-400";
                resultBox.innerHTML = `
        <div class="glow-card rounded-2xl p-8 mt-10 animate-fadeIn">
          <h3 class="text-2xl font-bold text-blue-400 mb-6 text-center">🏁 Prediction Result</h3>
          <div class="grid grid-cols-3 items-center justify-items-center gap-4">
            <div class="flex flex-col items-center">
              <span class="text-lg text-gray-300 player-name">${data.p1}</span>
              <strong class="text-4xl font-extrabold ${p1Prob > p2Prob ? winner : loser}">${data.p1_win}</strong>
            </div>
            <div class="text-gray-400 font-semibold text-xl select-none flex items-center justify-center">
              <div class="bg-blue-500/20 rounded-full px-5 py-1 border border-blue-400/30">VS</div>
            </div>
            <div class="flex flex-col items-center">
              <span class="text-lg text-gray-300 player-name">${data.p2}</span>
              <strong class="text-4xl font-extrabold ${p2Prob > p1Prob ? winner : loser}">${data.p2_win}</strong>
            </div>
          </div>
        </div>`;
            } else {
                const err = await response.json().catch(() => ({error: "Unexpected error"}));
                showPopupWarning(err.error);
            }
        });
    </script>
{% endblock %}
